<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{fragments/header :: header('Витрина интернет-магазина')}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<main class="container">
    <h4 class="page-title" th:text="${title != null ? title:'Все товары'}"></h4>
    <div class="row">
        <div id="productsContainer" class="col s8 offset-s2">
            <div th:replace="~{fragments/products-feed :: feed}"></div>
        </div>
        <br/>
    </div>
    <!--Content-->
    <div th:if="${products.totalElements > 0 and products.totalPages > 0}" class="row pagination-container">
        <!-- Выпадающий список выбора количества элементов -->
        <div class="col s6 m4">
            <form method="get" th:action="@{/products}">
                <label for="size">Элементов на странице:</label>
                <select id="size" name="size" class="browser-default" onchange="this.form.submit()">
                    <option th:value="10" th:selected="${size == 10}">10</option>
                    <option th:value="20" th:selected="${size == 20}">20</option>
                    <option th:value="50" th:selected="${size == 50}">50</option>
                    <option th:value="100" th:selected="${size == 100}">100</option>
                </select>
            </form>
        </div>

        <!-- Пагинация -->
        <div class="col s6 m8">
            <ul class="pagination right">
                <li th:class="${products.number eq 0} ? 'disabled=&quot;disabled&quot;' : ''">
                    <a th:if="${not products.first}"
                       th:href="@{/products(page=${products.number-1}, size=${size}, text=${param.text}, price_from=${param.price_from}, price_to=${param.price_to}, letter=${param.letter}, sorting=${selectedSorting})}">
                        <i class="material-icons">chevron_left</i>
                    </a>
                    <a th:if="${products.first}" href="#"><i class="material-icons">chevron_left</i></a>
                </li>
                <li th:each="pageNo : ${#numbers.sequence(0, products.totalPages - 1)}"
                    th:class="${products.number eq pageNo} ? 'active' : 'waves-effect'">
                    <a th:href="@{/products(page=${pageNo}, size=${size}, text=${param.text}, price_from=${param.price_from}, price_to=${param.price_to}, letter=${param.letter}, sorting=${selectedSorting})}"
                       th:text="${pageNo + 1}"></a>
                </li>
                <li th:class="${products.number + 1 ge products.totalPages} ? 'disabled=&quot;disabled&quot;' : ''">
                    <a th:if="${not products.last}"
                       th:href="@{/products(page=${products.number+1}, size=${size}, text=${param.text}, price_from=${param.price_from}, price_to=${param.price_to}, letter=${param.letter}, sorting=${selectedSorting})}">
                        <i class="material-icons">chevron_right</i>
                    </a>
                    <a th:if="${products.last}" href="#"><i class="material-icons">chevron_right</i></a>
                </li>
            </ul>
        </div>
    </div>
</main>
<!--container-->

<div th:replace="~{fragments/footer :: footer}"></div>
<script>
    $(document).ready(function() {
        // Инициализация Materialize select с множественным выбором
        $('select').material_select();

        // Проверяем, был ли фильтр открыт перед перезагрузкой страницы
        if (localStorage.getItem('filterVisible') === 'true') {
            $('#filterSection').show();
        }

        // Обработчик клика на кнопку фильтра (переключение видимости)
        $('#filterBtn').click(function(e) {
            e.preventDefault();
            $('#filterSection').slideToggle();

            // Сохраняем состояние в localStorage
            if ($('#filterSection').is(':visible')) {
                localStorage.setItem('filterVisible', 'true');
            } else {
                localStorage.setItem('filterVisible', 'false');
            }
        });

        function toggleClearButton() {
            const clearButton = $('#clearButton');
            const filterBtn = $('#filterBtn');
            const hasValues = $('#filterForm input:not([type="hidden"])').filter(function () {
                return this.value.trim() !== '';
            }).length > 0;
            clearButton.prop('disabled', !hasValues);

            // Добавляем или удаляем класс "active" у кнопки фильтра
            filterBtn.toggleClass('active', hasValues);
        }

        function clearFilter() {
            $('#filterForm input').val('');
            $('#filterForm').submit();
        }

        $('#filterForm').submit(function() {
            toggleClearButton();
        });

        // Обработчик очистки фильтра (не скрываем фильтр)
        $('#clearButton').click(function(e) {
            e.preventDefault();
            $('#filterForm input:not([type="hidden"])').val('');
            localStorage.setItem('filterVisible', 'true');  // Сохраняем, что фильтр был открыт
            $('#filterForm').submit(); // Отправляем форму (обновляет URL)
        });

        toggleClearButton();
        $('#filterForm input').on('input', toggleClearButton);

        $('.add-to-cart').on('click', function () {
            const button = $(this);
            const productId = button.data('product-id');

            $.ajax({
                url: '/cart',
                method: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ productId: productId, quantity: 1 }),
                success: function (response) {
                    button.hide();
                    const controls = button.siblings('.quantity-controls');
                    controls.show();
                    controls.find('.quantity-input').val(response.quantity).data('cart-item-id', response.id);
                },
                error: function () {
                    alert('Ошибка при добавлении в корзину.');
                }
            });
        });

        $(document).on('click', '.plus, .minus', function () {
            const button = $(this);
            const controls = button.closest('.quantity-controls');
            const input = controls.find('.quantity-input');
            let count = parseInt(input.val());
            if (button.hasClass('plus')) count++;
            else count--;

            const cartItemId = input.data('cart-item-id');
            const productId = button.closest('.product-row').find('.add-to-cart').data('product-id');

            $.ajax({
                url: '/cart',
                method: 'PUT',
                contentType: 'application/json',
                data: JSON.stringify({ id: cartItemId, productId: productId, quantity: count }),
                success: function (response) {
                    if (response.quantity === 0) {
                        controls.hide();
                        controls.siblings('.add-to-cart').show();
                    } else {
                        input.val(response.quantity);
                    }
                },
                error: function () {
                    alert('Ошибка при обновлении количества.');
                }
            });
        });

        $('#size').on('change', function () {
            const size = $(this).val();
            const url = new URL(window.location.href);
            url.searchParams.set('size', size);
            window.location.href = url;
        });
    });
</script>
</body>
</html>